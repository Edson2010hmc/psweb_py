#!/usr/bin/env python3
# -*- coding: utf-8 -*-

#Script corrigido para executar o servidor PSWEB Python
#Localiza√ß√£o: c:\Users\Public\psweb_py\run_server.py


import sys
import os
from pathlib import Path

def setup_python_path():
    """Configura o PYTHONPATH para a estrutura correta"""
    # Diret√≥rio base do projeto
    base_dir = Path(__file__).parent
    
    # Adiciona o diret√≥rio backend ao Python path
    backend_dir = base_dir / "backend"
    
    if str(backend_dir) not in sys.path:
        sys.path.insert(0, str(backend_dir))
    
    print(f"Python path configurado:")
    print(f"  Base: {base_dir}")
    print(f"  Backend: {backend_dir}")
    
    return backend_dir

def test_imports():
    """Testa se os imports principais funcionam"""
    print("\nTestando imports...")
    
    try:
        # Testa FastAPI
        import fastapi
        print("  ‚úì FastAPI dispon√≠vel")
        
        # Testa uvicorn
        import uvicorn
        print("  ‚úì Uvicorn dispon√≠vel")
        
        # Testa FDB
        import firebird.driver as fdb
        print("  ‚úì FDB (Firebird) dispon√≠vel")
        
        # Testa se consegue importar o app
        from app.main import app
        print("  ‚úì App principal importado")
        
        return True
        
    except ImportError as e:
        print(f"  ‚úó Erro de import: {e}")
        return False
    except Exception as e:
        print(f"  ‚úó Erro inesperado: {e}")
        return False

def check_files():
    """Verifica se os arquivos necess√°rios existem"""
    print("\nVerificando arquivos...")
    
    base_dir = Path(__file__).parent
    required_files = [
        "backend/app/main.py",
        "backend/app/config/settings.py",
        "backend/app/config/database.py"
    ]
    
    missing = []
    for file_path in required_files:
        full_path = base_dir / file_path
        if full_path.exists():
            print(f"  ‚úì {file_path}")
        else:
            print(f"  ‚úó {file_path} (FALTANDO)")
            missing.append(file_path)
    
    return len(missing) == 0

def main():
    """Fun√ß√£o principal"""
    print("PSWEB Python - Iniciando Servidor")
    print("=" * 50)
    
    try:
        # 1. Configurar Python path
        backend_dir = setup_python_path()
        
        # 2. Verificar arquivos
        if not check_files():
            print("\n‚ùå Arquivos necess√°rios faltando!")
            print("Execute primeiro: python cleanup_structure.py")
            return False
        
        # 3. Testar imports
        if not test_imports():
            print("\n‚ùå Erro nos imports!")
            print("Verifique se a estrutura est√° correta")
            return False
        
        # 4. Importar e executar
        print("\nüöÄ Iniciando servidor...")
        from app.main import app
        from app.config.settings import settings
        import uvicorn
        
        print(f"Servidor: http://{settings.HOST}:{settings.PORT}")
        print(f"Documenta√ß√£o: http://{settings.HOST}:{settings.PORT}/docs")
        print("Pressione Ctrl+C para parar")
        
        uvicorn.run(
            app,
            host=settings.HOST,
            port=settings.PORT,
            reload=settings.DEBUG,
            log_level="info"
        )
        
        return True
        
    except KeyboardInterrupt:
        print("\nüëã Servidor interrompido pelo usu√°rio")
        return True
    except ImportError as e:
        print(f"\n‚ùå Erro de import: {e}")
        print("\nPoss√≠veis solu√ß√µes:")
        print("1. Verificar se a estrutura est√° correta")
        print("2. Executar: python cleanup_structure.py")
        print("3. Verificar depend√™ncias: pip install -r backend/requirements.txt")
        return False
    except Exception as e:
        print(f"\n‚ùå Erro inesperado: {e}")
        return False

if __name__ == "__main__":
    success = main()
    if not success:
        sys.exit(1)