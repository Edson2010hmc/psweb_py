/**
 * ARQUIVO: frontend/static/js/modules/auth/auth.js
 * PSWEB - M√≥dulo de Autentica√ß√£o - SEM TOKENS
 * PASSO 2: ADICIONADA inicializa√ß√£o da vari√°vel global USERNAME
 * PASSO 3: USAR USERNAME GLOBAL PARA AUTENTICA√á√ÉO E DEFINI√á√ÉO DE PERFIL
 */

(() => {
    'use strict';

    const MODULE_NAME = 'AuthModule';

    // ===================================================================================================
    // CONFIGURA√á√ÉO DE DEBUG
    // ===================================================================================================
    let DEBUG_CONFIG = {
        DEBUG: false,
        DEBUG_AUTH: false
    };

    function debugLog(message, data = null) {
        if (DEBUG_CONFIG.DEBUG_AUTH) {
            console.log(`üîê [${MODULE_NAME} DEBUG] ${message}`, data || '');
        }
    }

    function debugError(message, error = null) {
        if (DEBUG_CONFIG.DEBUG_AUTH) {
            console.error(`‚ùå [${MODULE_NAME} ERROR] ${message}`, error || '');
        }
        console.error(`‚ùå ${MODULE_NAME}: ${message}`, error || '');
    }

    // ===================================================================================================
    // ESTADO (SEM TOKENS)
    // ===================================================================================================
    let context = null;  // REMOVIDO: authToken
    let authConfig = null;
    let isInitialized = false;
    let onAuthSuccessCallback = null;

    // ===================================================================================================
    // API SEM TOKENS - PASSO 3: MODIFICADA para usar USERNAME global
    // ===================================================================================================
    const api = {
        async getAuthInfo() {
            const response = await fetch('/api/auth/info');
            return response.json();
        },

        async initUsername() {
            // PASSO 2: Inicializa USERNAME global no servidor
            const response = await fetch('/api/auth/init-username', { method: 'POST' });
            return response.json();
        },

        async authenticateWindows() {
            // PASSO 3: Autentica√ß√£o usando USERNAME global
            const response = await fetch('/api/auth/windows', { method: 'POST' });
            return response.json();
        },

        async getCurrentUser() {
            // PASSO 3: Nova rota que usa USERNAME global
            const response = await fetch('/api/auth/me');
            return response.json();
        },

        async logout() {
            const response = await fetch('/api/auth/logout', { method: 'POST' });
            return response.json();
        },

        async testWindowsCapture() {
            const response = await fetch('/api/auth/test-windows');
            return response.json();
        }
    };

    // ===================================================================================================
    // UTILIT√ÅRIOS
    // ===================================================================================================
    function getElement(id) {
        return document.getElementById(id);
    }

    function showError(message) {
        debugError('showError chamado', message);
        console.error('‚ùå Auth Error:', message);
        alert('Erro de Autentica√ß√£o:\n\n' + message);
    }

    function showMessage(message) {
        debugLog('showMessage chamado', message);
        console.log('‚ÑπÔ∏è Auth Info:', message);
    }

    // ===================================================================================================
    // CONTROLE DE INTERFACE SIMPLIFICADO
    // ===================================================================================================
    function setUserDisplay(name) {
        debugLog('setUserDisplay chamado', { name });
        const userNameEl = getElement('userName');
        if (userNameEl) {
            userNameEl.textContent = name || '';
            debugLog('Nome do usu√°rio atualizado na interface', name);
        } else {
            debugError('Elemento userName n√£o encontrado');
        }
    }

    async function updateContextualInfo(userContext) {
        debugLog('updateContextualInfo chamado', userContext);
        
        if (!userContext) {
            debugError('Contexto de usu√°rio inv√°lido');
            return;
        }

        // Atualiza nome do usu√°rio
        debugLog('Atualizando nome do usu√°rio', userContext.nome);
        setUserDisplay(userContext.nome || '');

        // CORRE√á√ÉO: Garante que o profile esteja definido
        if (!userContext.profile) {
            debugError('Profile n√£o definido no contexto');
            return;
        }

        // DELEGA controle de perfil para callbacks externos
        debugLog('Delegando controle de perfil para m√≥dulo principal...');
        if (onAuthSuccessCallback && typeof onAuthSuccessCallback === 'function') {
            debugLog('Executando callback onAuthSuccess...');
            await onAuthSuccessCallback();
        }

        // Log para debug
        const contextInfo = {
            nome: userContext.nome,
            profile: userContext.profile,
            isFiscal: userContext.isFiscal,
            isAdmin: userContext.isAdmin,
            fiscalId: userContext.fiscalId
        };
        
        debugLog('üîÑ AuthModule: Contexto processado', contextInfo);
        console.log('üîÑ PASSO 3: Contexto processado via USERNAME global:', contextInfo);
    }

    // ===================================================================================================
    // INICIALIZA√á√ÉO USERNAME GLOBAL - PASSO 2
    // ===================================================================================================
    async function initializeUsernameOnServer() {
        try {
            debugLog('üîê Inicializando USERNAME global no servidor...');
            
            const result = await api.initUsername();
            
            if (result.success) {
                debugLog('‚úÖ USERNAME global inicializado', {
                    username: result.username,
                    already_initialized: result.already_initialized,
                    message: result.message
                });
                
                console.log(`‚úÖ USERNAME Windows: ${result.username} ${result.already_initialized ? '(j√° inicializado)' : '(inicializado agora)'}`);
                return result;
            } else {
                debugError('‚ùå Falha ao inicializar USERNAME global', result);
                throw new Error(result.message || 'Falha ao inicializar USERNAME');
            }
            
        } catch (error) {
            debugError('‚ùå Erro ao inicializar USERNAME global', error);
            throw error;
        }
    }

    // ===================================================================================================
    // OPERA√á√ïES DE AUTENTICA√á√ÉO - PASSO 3: SIMPLIFICADAS
    // ===================================================================================================
    async function performAuthentication() {
        try {
            debugLog('üöÄ PASSO 3: Iniciando autentica√ß√£o via USERNAME global...');
            console.log('üöÄ PASSO 3: Iniciando autentica√ß√£o via USERNAME global...');

            // 1. Verifica se USERNAME global est√° inicializado
            debugLog('üì° Verificando configura√ß√µes do servidor...');
            authConfig = await api.getAuthInfo();
            debugLog('‚úÖ Configura√ß√£o recebida', authConfig);

            if (!authConfig.global_username_initialized) {
                throw new Error('USERNAME global n√£o est√° inicializado no servidor');
            }

            // 2. PASSO 3: Autentica usando USERNAME global
            debugLog('üîê Autenticando via USERNAME global...');
            const authResult = await api.authenticateWindows();
            debugLog('‚úÖ Autentica√ß√£o bem-sucedida', {
                profile: authResult.profile,
                nome: authResult.user?.nome,
                message: authResult.message
            });

            // 3. Armazena contexto do usu√°rio
            context = authResult.user;

            // CORRE√á√ÉO: Garante que o profile seja armazenado corretamente
            if (authResult.profile) {
                context.profile = authResult.profile;
            }

            debugLog('üìù Contexto armazenado', {
                context_profile: context?.profile,
                context_nome: context?.nome,
                context_fiscalId: context?.fiscalId,
                full_context: context
            });

            // 4. Atualiza interface
            debugLog('üñ•Ô∏è Atualizando interface...');
            await updateContextualInfo(context);

            debugLog('‚úÖ PASSO 3: Processo de autentica√ß√£o conclu√≠do com sucesso');
            console.log('‚úÖ PASSO 3: Processo de autentica√ß√£o conclu√≠do com sucesso');

            return authResult;

        } catch (error) {
            debugError('‚ùå Erro na autentica√ß√£o:', error);
            showError(error.message + '\n\nVerifique se:\n1. O USERNAME foi inicializado corretamente\n2. Voc√™ est√° cadastrado no sistema como Fiscal ou Administrador\n3. O servidor est√° funcionando corretamente');
            throw error;
        }
    }

    async function checkCurrentUser() {
        try {
            debugLog('üîç PASSO 3: Verificando usu√°rio atual via USERNAME global...');
            
            const userResponse = await api.getCurrentUser();
            
            if (userResponse.success && userResponse.user) {
                context = userResponse.user;
                
                debugLog('‚úÖ PASSO 3: Usu√°rio obtido via USERNAME global', {
                    nome: userResponse.user.nome,
                    profile: userResponse.profile,
                    fiscalId: userResponse.user.fiscalId
                });
                
                await updateContextualInfo(context);
                return userResponse.user;
            } else {
                throw new Error(userResponse.message || 'Usu√°rio n√£o encontrado');
            }
            
        } catch (error) {
            debugLog('‚ö†Ô∏è PASSO 3: Erro ao obter usu√°rio atual, tentando autentica√ß√£o completa');
            return await performAuthentication();
        }
    }

    async function performLogout() {
        try {
            debugLog('üö™ Executando logout...');
            
            const result = await api.logout();
            
            // Limpa contexto
            context = null;
            
            debugLog('‚úÖ Logout conclu√≠do');
            showMessage(result.message || 'Logout realizado com sucesso');
            
            // Recarrega p√°gina para resetar estado
            window.location.reload();
            
        } catch (error) {
            debugError('‚ùå Erro no logout:', error);
            showError('Erro durante logout: ' + error.message);
        }
    }

    // ===================================================================================================
    // VERIFICA√á√ÉO DE STATUS - PASSO 3: SIMPLIFICADA
    // ===================================================================================================
    async function checkAuthenticationStatus() {
        debugLog('üîç PASSO 3: Verificando status de autentica√ß√£o...');
        
        try {
            // PASSO 3: Primeiro tenta obter usu√°rio atual via USERNAME global
            return await checkCurrentUser();
            
        } catch (error) {
            debugError('‚ùå Erro ao verificar status de auth', error);
            console.error('‚ùå Erro ao verificar status de auth:', error);
            throw error;
        }
    }

    // ===================================================================================================
    // EVENT LISTENERS SIMPLIFICADOS
    // ===================================================================================================
    function bindEvents() {
        debugLog('üîó Configurando event listeners...');
        
        // Bot√£o de logout
        const btnLogout = getElement('btnLogout');
        if (btnLogout) {
            btnLogout.addEventListener('click', performLogout);
            debugLog('Event listener logout configurado');
        }
        
        // Remove modal de login (n√£o √© mais necess√°rio)
        const loginModal = getElement('loginModal');
        if (loginModal) {
            loginModal.style.display = 'none';
            debugLog('Modal de login removido');
        }
    }

    // ===================================================================================================
    // CARREGAMENTO DE CONFIGURA√á√ÉO
    // ===================================================================================================
    async function loadDebugConfig() {
        try {
            const response = await fetch('/api/auth/debug-config');
            if (response.ok) {
                const result = await response.json();
                DEBUG_CONFIG = result.config || {};
                debugLog('Debug config carregada', DEBUG_CONFIG);
            }
        } catch (error) {
            debugLog('Debug config n√£o dispon√≠vel (production mode)');
        }
    }

    // ===================================================================================================
    // INTERFACE P√öBLICA - PASSO 3: SIMPLIFICADA
    // ===================================================================================================
    const moduleInstance = {
        // Inicializa√ß√£o
        async init() {
            debugLog('üöÄ Inicializando m√≥dulo de autentica√ß√£o...');
            
            try {
                // Carrega configura√ß√£o de debug
                await loadDebugConfig();
                
                // PASSO 2: Inicializa USERNAME global no servidor
                debugLog('üîê Chamando inicializa√ß√£o de USERNAME global...');
                await initializeUsernameOnServer();
                
                // Configura event listeners
                bindEvents();
                
                isInitialized = true;
                debugLog('‚úÖ M√≥dulo inicializado (aguardando autentica√ß√£o)');
                
            } catch (error) {
                debugError('‚ùå Erro na inicializa√ß√£o:', error);
                throw error;
            }
        },

        // Autentica√ß√£o principal - PASSO 3: SIMPLIFICADA
        async checkOrAuthenticate() {
            debugLog('üîê PASSO 3: checkOrAuthenticate chamado');
            
            if (!isInitialized) {
                throw new Error('M√≥dulo n√£o inicializado');
            }
            
            return await checkAuthenticationStatus();
        },

        // Callbacks
        setOnAuthSuccessCallback(callback) {
            onAuthSuccessCallback = callback;
            debugLog('Callback onAuthSuccess configurado');
        },

        // Logout
        async logout() {
            return await performLogout();
        },

        // Estado atual
        getCurrentUser() {
            return context;
        },

        isAuthenticated() {
            return context !== null;
        },

        // PASSO 3: NOVA FUN√á√ÉO para verificar usu√°rio atual
        async refreshCurrentUser() {
            return await checkCurrentUser();
        },

        // API para compatibilidade
        api: {
            getCurrentUser: () => context,
            authenticateWindows: () => performAuthentication(),
            getAuthInfo: api.getAuthInfo,
            logout: performLogout,
            initUsername: api.initUsername,
            refreshUser: () => checkCurrentUser()  // NOVA
        }
    };

    // ===================================================================================================
    // REGISTRO GLOBAL
    // ===================================================================================================
    window.AuthModule = moduleInstance;
    
    console.log(`üì¶ ${MODULE_NAME}: M√≥dulo de autentica√ß√£o PASSO 3 - USERNAME GLOBAL para autentica√ß√£o registrado`);

})();